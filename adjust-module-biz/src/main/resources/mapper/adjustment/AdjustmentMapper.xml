<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hongguoyan.module.biz.dal.mysql.adjustment.AdjustmentMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.iocoder.cn/MyBatis/x-plugins/
     -->

    <sql id="SearchWhere">
        <where>
            <if test="reqVO.keyword != null and reqVO.keyword != ''">
                AND MATCH(a.school_name, a.major_name, a.major_code,
                    a.subject_name1, a.subject_name2, a.subject_name3, a.subject_name4)
                AGAINST(#{reqVO.keyword} IN BOOLEAN MODE)
            </if>
            <if test="reqVO.majorCode != null and reqVO.majorCode != ''">
                AND a.major_code LIKE CONCAT(#{reqVO.majorCode}, '%')
            </if>
            <if test="reqVO.year != null">
                AND a.year = #{reqVO.year}
            </if>
            <if test="reqVO.studyMode != null and reqVO.studyMode != ''">
                AND a.study_mode = #{reqVO.studyMode}
            </if>
            <if test="reqVO.degreeType != null">
                AND a.degree_type = #{reqVO.degreeType}
            </if>

            <if test="reqVO.provinceCodes != null and reqVO.provinceCodes.size() &gt; 0">
                AND s.province_code IN
                <foreach collection="reqVO.provinceCodes" item="code" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>

            <if test="reqVO.level2MajorCodes != null and reqVO.level2MajorCodes.size() &gt; 0">
                AND (
                <foreach collection="reqVO.level2MajorCodes" item="code" separator=" OR ">
                    a.major_code LIKE CONCAT(#{code}, '%')
                </foreach>
                )
            </if>

            <if test="reqVO.is985 != null">
                AND s.is_985 = #{reqVO.is985}
            </if>
            <if test="reqVO.is211 != null">
                AND s.is_211 = #{reqVO.is211}
            </if>
            <if test="reqVO.isSyl != null">
                AND s.is_syl = #{reqVO.isSyl}
            </if>

            <if test="reqVO.schoolFeature != null and reqVO.schoolFeature != ''">
                <choose>
                    <when test="reqVO.schoolFeature == '985'">
                        AND s.is_985 = 1
                    </when>
                    <when test="reqVO.schoolFeature == '211'">
                        AND s.is_211 = 1
                    </when>
                    <when test="reqVO.schoolFeature == 'syl'">
                        AND s.is_syl = 1
                    </when>
                    <when test="reqVO.schoolFeature == 'other'">
                        AND IFNULL(s.is_985, 0) = 0
                        AND IFNULL(s.is_211, 0) = 0
                        AND IFNULL(s.is_syl, 0) = 0
                    </when>
                </choose>
            </if>

            <if test="reqVO.adjustStatus != null">
                AND a.adjust_status = #{reqVO.adjustStatus}
            </if>
            <if test="reqVO.specialPlan != null">
                AND a.special_plan = #{reqVO.specialPlan}
            </if>
            <if test="reqVO.adjustType != null">
                AND a.adjust_type = #{reqVO.adjustType}
            </if>

            <if test="reqVO.publishTime != null and reqVO.publishTime.length == 2 and reqVO.publishTime[0] != null and reqVO.publishTime[1] != null">
                AND a.publish_time BETWEEN #{reqVO.publishTime[0]} AND #{reqVO.publishTime[1]}
            </if>

            <if test="reqVO.subjectCodes != null and reqVO.subjectCodes.size() &gt; 0">
                AND (
                    a.subject_code1 IN
                    <foreach collection="reqVO.subjectCodes" item="code" open="(" separator="," close=")">
                        #{code}
                    </foreach>
                    OR a.subject_code2 IN
                    <foreach collection="reqVO.subjectCodes" item="code" open="(" separator="," close=")">
                        #{code}
                    </foreach>
                    OR a.subject_code3 IN
                    <foreach collection="reqVO.subjectCodes" item="code" open="(" separator="," close=")">
                        #{code}
                    </foreach>
                    OR a.subject_code4 IN
                    <foreach collection="reqVO.subjectCodes" item="code" open="(" separator="," close=")">
                        #{code}
                    </foreach>
                )
            </if>
        </where>
    </sql>

    <sql id="HotRankingWhere">
        <where>
            AND a.deleted = b'0'
            <if test="reqVO.year != null">
                AND a.year = #{reqVO.year}
            </if>
            <if test="reqVO.studyMode != null and reqVO.studyMode != ''">
                AND a.study_mode = #{reqVO.studyMode}
            </if>
            <if test="reqVO.provinceCode != null and reqVO.provinceCode != ''">
                AND s.province_code = #{reqVO.provinceCode}
            </if>
        </where>
    </sql>

    <select id="selectSearchMajorPage"
            resultType="com.hongguoyan.module.biz.controller.app.adjustment.vo.AppAdjustmentSearchRespVO">
        SELECT
            a.school_id AS schoolId,
            a.college_id AS collegeId,
            a.major_id AS majorId,
            a.school_name AS schoolName,
            a.major_code AS majorCode,
            a.major_name AS majorName,
            a.year,
            a.study_mode AS studyMode,
            a.adjust_count AS adjustCount,
            a.publish_time AS updateTime,
            COALESCE(sm.view_count, 0) AS viewCount,
            COALESCE(sm.hot_score, 0) AS hotScore,
            s.province_name AS provinceName
        FROM (
            SELECT a2.*
            FROM biz_adjustment a2
            JOIN (
                SELECT
                    a.school_id,
                    a.college_id,
                    a.major_id,
                    a.year,
                    CASE
                        WHEN a.year = YEAR(CURDATE()) THEN
                            MAX(CONCAT(DATE_FORMAT(a.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(a.id, 20, '0')))
                        ELSE
                            MIN(CONCAT(DATE_FORMAT(a.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(a.id, 20, '0')))
                    END AS pick_key
                FROM biz_adjustment a
                LEFT JOIN biz_school s ON s.id = a.school_id
                <include refid="SearchWhere" />
                GROUP BY a.school_id, a.college_id, a.major_id, a.year
            ) pick ON pick.school_id = a2.school_id
                AND pick.college_id = a2.college_id
                AND pick.major_id = a2.major_id
                AND pick.year = a2.year
                AND pick.pick_key = CONCAT(DATE_FORMAT(a2.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(a2.id, 20, '0'))
        ) a
        LEFT JOIN biz_school s ON s.id = a.school_id
        LEFT JOIN biz_school_major sm ON sm.school_id = a.school_id
            AND sm.college_id = a.college_id
            AND sm.major_id = a.major_id
        ORDER BY hotScore DESC, updateTime DESC
    </select>

    <select id="selectHotRankingPage"
            resultType="com.hongguoyan.module.biz.controller.app.adjustment.vo.AppAdjustmentSearchRespVO">
        SELECT
            a.school_id AS schoolId,
            a.college_id AS collegeId,
            a.major_id AS majorId,
            a.school_name AS schoolName,
            a.major_code AS majorCode,
            a.major_name AS majorName,
            a.year,
            a.study_mode AS studyMode,
            a.adjust_count AS adjustCount,
            a.publish_time AS updateTime,
            COALESCE(sm.view_count, 0) AS viewCount,
            COALESCE(sm.hot_score, 0) AS hotScore,
            s.province_name AS provinceName
        FROM (
            SELECT a2.*
            FROM biz_adjustment a2
            JOIN (
                SELECT
                    a.school_id,
                    a.college_id,
                    a.major_id,
                    a.year,
                    CASE
                        WHEN a.year = YEAR(CURDATE()) THEN
                            MAX(CONCAT(DATE_FORMAT(a.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(a.id, 20, '0')))
                        ELSE
                            MIN(CONCAT(DATE_FORMAT(a.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(a.id, 20, '0')))
                    END AS pick_key
                FROM biz_adjustment a
                LEFT JOIN biz_school s ON s.id = a.school_id
                <include refid="HotRankingWhere" />
                GROUP BY a.school_id, a.college_id, a.major_id, a.year
            ) pick ON pick.school_id = a2.school_id
                AND pick.college_id = a2.college_id
                AND pick.major_id = a2.major_id
                AND pick.year = a2.year
                AND pick.pick_key = CONCAT(DATE_FORMAT(a2.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(a2.id, 20, '0'))
        ) a
        LEFT JOIN biz_school s ON s.id = a.school_id
        LEFT JOIN biz_school_major sm ON sm.school_id = a.school_id
            AND sm.college_id = a.college_id
            AND sm.major_id = a.major_id
        ORDER BY hotScore DESC, updateTime DESC
    </select>

    <select id="selectSearchSchoolPage"
            resultType="com.hongguoyan.module.biz.controller.app.adjustment.vo.AppAdjustmentSearchSchoolRespVO">
        SELECT
            a.school_id AS schoolId,
            a.school_name AS schoolName,
            s.school_type AS schoolType,
            s.province_name AS provinceName,
            a.year,
            a.college_id AS collegeId,
            a.major_id AS majorId,
            a.adjust_count AS adjustCount,
            a.publish_time AS updateTime,
            s.is_985 AS is985,
            s.is_211 AS is211,
            s.is_syl AS isSyl
        FROM (
            SELECT a2.*
            FROM biz_adjustment a2
            JOIN (
                SELECT
                    a.school_id,
                    a.year,
                    CASE
                        WHEN a.year = YEAR(CURDATE()) THEN
                            MAX(CONCAT(DATE_FORMAT(a.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(a.id, 20, '0')))
                        ELSE
                            MIN(CONCAT(DATE_FORMAT(a.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(a.id, 20, '0')))
                    END AS pick_key
                FROM biz_adjustment a
                LEFT JOIN biz_school s ON s.id = a.school_id
                <include refid="SearchWhere" />
                GROUP BY a.school_id, a.year
            ) pick ON pick.school_id = a2.school_id
                AND pick.year = a2.year
                AND pick.pick_key = CONCAT(DATE_FORMAT(a2.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(a2.id, 20, '0'))
        ) a
        LEFT JOIN biz_school s ON s.id = a.school_id
        ORDER BY updateTime DESC
    </select>

    <select id="selectRecruitSnapshotLatest"
            resultType="com.hongguoyan.module.biz.dal.mysql.adjustment.dto.RecruitSnapshotRowDTO">
        SELECT
            r.school_id AS schoolId,
            r.college_id AS collegeId,
            r.major_id AS majorId,
            r.year,
            r.recruit_number AS recruitNumber
        FROM biz_recruit r
        JOIN (
            SELECT
                school_id,
                college_id,
                major_id,
                year,
                MAX(CONCAT(DATE_FORMAT(publish_time, '%Y%m%d%H%i%s'), '-', LPAD(id, 20, '0'))) AS pick_key
            FROM biz_recruit
            WHERE (school_id, college_id, major_id, year) IN
            <foreach collection="keys" item="k" open="(" separator="," close=")">
                (#{k.schoolId}, #{k.collegeId}, #{k.majorId}, #{k.year})
            </foreach>
            GROUP BY school_id, college_id, major_id, year
        ) pick ON pick.school_id = r.school_id
            AND pick.college_id = r.college_id
            AND pick.major_id = r.major_id
            AND pick.year = r.year
            AND pick.pick_key = CONCAT(DATE_FORMAT(r.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(r.id, 20, '0'))
    </select>

    <select id="selectRecruitSnapshotEarliest"
            resultType="com.hongguoyan.module.biz.dal.mysql.adjustment.dto.RecruitSnapshotRowDTO">
        SELECT
            r.school_id AS schoolId,
            r.college_id AS collegeId,
            r.major_id AS majorId,
            r.year,
            r.recruit_number AS recruitNumber
        FROM biz_recruit r
        JOIN (
            SELECT
                school_id,
                college_id,
                major_id,
                year,
                MIN(CONCAT(DATE_FORMAT(publish_time, '%Y%m%d%H%i%s'), '-', LPAD(id, 20, '0'))) AS pick_key
            FROM biz_recruit
            WHERE (school_id, college_id, major_id, year) IN
            <foreach collection="keys" item="k" open="(" separator="," close=")">
                (#{k.schoolId}, #{k.collegeId}, #{k.majorId}, #{k.year})
            </foreach>
            GROUP BY school_id, college_id, major_id, year
        ) pick ON pick.school_id = r.school_id
            AND pick.college_id = r.college_id
            AND pick.major_id = r.major_id
            AND pick.year = r.year
            AND pick.pick_key = CONCAT(DATE_FORMAT(r.publish_time, '%Y%m%d%H%i%s'), '-', LPAD(r.id, 20, '0'))
    </select>

    <select id="selectMajorsHasHistoryAdjust"
            resultType="com.hongguoyan.module.biz.dal.mysql.adjustment.dto.BizMajorKeyDTO">
        SELECT DISTINCT
            hx.school_id AS schoolId,
            hx.college_id AS collegeId,
            hx.major_id AS majorId
        FROM biz_adjustment hx
        WHERE hx.year &lt; #{currentYear}
          AND hx.adjust_count &gt; 0
          AND (hx.school_id, hx.college_id, hx.major_id) IN
          <foreach collection="triplets" item="k" open="(" separator="," close=")">
              (#{k.schoolId}, #{k.collegeId}, #{k.majorId})
          </foreach>
    </select>

    <select id="selectOptionYears" resultType="java.lang.Integer">
        SELECT DISTINCT a.year
        FROM biz_adjustment a
        WHERE a.school_id = #{schoolId}
          AND a.major_id = #{majorId}
        ORDER BY a.year DESC
    </select>

    <select id="selectOptionColleges"
            resultType="com.hongguoyan.module.biz.controller.app.adjustment.vo.AppAdjustmentCollegeOptionRespVO">
        SELECT DISTINCT
            a.college_id AS collegeId,
            a.college_name AS collegeName
        FROM biz_adjustment a
        WHERE a.school_id = #{schoolId}
          AND a.major_id = #{majorId}
        ORDER BY a.college_name ASC
    </select>

    <select id="selectOptionStudyModes" resultType="java.lang.String">
        SELECT DISTINCT a.study_mode
        FROM biz_adjustment a
        WHERE a.school_id = #{schoolId}
          AND a.college_id = #{collegeId}
          AND a.major_id = #{majorId}
        ORDER BY
            CASE a.study_mode
                WHEN '全日制' THEN 0
                WHEN '非全日制' THEN 1
                ELSE 9
            END,
            a.study_mode ASC
    </select>

    <select id="selectUpdateStats"
            resultType="com.hongguoyan.module.biz.controller.app.adjustment.vo.AppAdjustmentUpdateStatsRespVO">
        SELECT
            #{year} AS year,
            MAX(a.update_time) AS lastUpdateTime,
            SUM(CASE
                    WHEN a.update_time &gt;= CURDATE()
                     AND a.update_time &lt; DATE_ADD(CURDATE(), INTERVAL 1 DAY)
                    THEN 1 ELSE 0 END) AS todayUpdateCount,
            COUNT(DISTINCT CASE
                    WHEN a.update_time &gt;= CURDATE()
                     AND a.update_time &lt; DATE_ADD(CURDATE(), INTERVAL 1 DAY)
                    THEN a.school_id ELSE NULL END) AS todayUpdateSchoolCount,
            COUNT(*) AS totalCount,
            COUNT(DISTINCT a.school_id) AS totalSchoolCount
        FROM biz_adjustment a
        WHERE a.year = #{year}
    </select>

    <select id="selectSchoolAdjustmentPage"
            resultType="com.hongguoyan.module.biz.controller.app.school.vo.AppSchoolAdjustmentRespVO">
        SELECT
            a.school_id AS schoolId,
            a.college_id AS collegeId,
            a.major_id AS majorId,
            MAX(a.major_code) AS majorCode,
            MAX(a.major_name) AS majorName,
            MAX(a.college_name) AS collegeName,
            a.year AS year,
            a.study_mode AS studyMode,
            SUM(a.adjust_count) AS adjustCount
        FROM biz_adjustment a
        WHERE a.school_id = #{reqVO.schoolId}
        GROUP BY a.school_id, a.college_id, a.major_id, a.year, a.study_mode
        ORDER BY a.year DESC, MAX(a.update_time) DESC
    </select>

</mapper>
